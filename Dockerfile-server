FROM rust:1.67-slim-buster

# Install protoc
RUN apt-get update && apt-get install -y protobuf-compiler

# Create a new rust project
RUN USER=root cargo new --bin server

WORKDIR /server

# Copy cargo files, the build.rs and the protos to the new project
COPY ./server/Cargo.lock ./Cargo.lock
COPY ./server/Cargo.toml ./Cargo.toml
COPY ./server/build.rs ./build.rs
COPY ./server/protos ./protos

# Build for production
RUN cargo build --release

# Remove existing src files generated by the new project
RUN rm src/*.rs

# Copy existing src files generated by the new project
COPY ./server/src ./src

RUN rm ./target/release/deps/server*

# Install dependencies
RUN cargo install --path .

EXPOSE 8080

CMD ["server"]