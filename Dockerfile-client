FROM rust:1.67-slim-buster

# Install protoc
RUN apt-get update && apt-get install -y protobuf-compiler

# Create a new rust project
RUN USER=root cargo new --bin client

WORKDIR /client

# Copy cargo files, the build.rs and the protos to the new project
COPY ./client/Cargo.lock ./Cargo.lock
COPY ./client/Cargo.toml ./Cargo.toml
COPY ./client/build.rs ./build.rs
COPY ./client/protos ./protos

# Build for production
RUN cargo build --release

# Remove existing src files generated by the new project
RUN rm src/*.rs

# Copy existing src files generated by the new project
COPY ./client/src ./src

RUN rm ./target/release/deps/client*

# Install dependencies
RUN cargo install --path .

CMD ["client"]